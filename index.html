<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponto Exato â€“ Entregas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#0d47a1;color:#fff;padding:10px;text-align:center}
#map{height:55vh}
.controls{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:#fff}
button{padding:10px;border:none;border-radius:6px;font-size:14px}
.btn{background:#1976d2;color:#fff}
.btn-green{background:#2e7d32;color:#fff}
.btn-orange{background:#ef6c00;color:#fff}
.list{max-height:30vh;overflow:auto;background:#fff;padding:8px}
.item{padding:6px;border-bottom:1px solid #ddd}
.item.active{background:#e3f2fd}
</style>
</head>

<body>

<header>ğŸ“¦ Ponto Exato â€“ Entregas</header>
<div id="map"></div>

<div class="controls">
  <button class="btn" onclick="ativarGPS()">ğŸ“¡ GPS</button>
  <button class="btn" onclick="buscarCEP()">ğŸ” CEP</button>
  <button class="btn" onclick="novaEntrega()">ğŸ“ Nova</button>
  <button class="btn-green" onclick="falar('Sistema funcionando')">ğŸ”Š Voz</button>
  <button class="btn-orange" onclick="limparTudo()">ğŸ—‘ Limpar</button>
  <button class="btn-orange" onclick="limparRota()">ğŸ§¹ Limpar rota</button>

</div>

<div class="list" id="lista"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================= MAPA =================
const map = L.map('map').setView([-15.78,-47.93],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

// ================= ESTADO =================
let entregas = JSON.parse(localStorage.getItem('entregas')) || [];
let entregaAtiva = null;
let gpsLatLng = null;
let gpsMarker = null;
let rotaLinha = null;
let avisos = {};
let markers = [];

// ================= VOZ =================
function falar(txt){
  if(!('speechSynthesis' in window)) return;
  speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(txt);
  msg.lang = 'pt-BR';
  speechSynthesis.speak(msg);
}

// ================= VIBRAÃ‡ÃƒO =================
function vibrar(p){ if(navigator.vibrate) navigator.vibrate(p); }

// ================= SALVAR =================
function salvar(){
  localStorage.setItem('entregas', JSON.stringify(entregas));
}

// ================= LISTA =================
function atualizarLista(){
  const l = document.getElementById('lista');
  l.innerHTML='';
  entregas.forEach((e,i)=>{
    const d = document.createElement('div');
    d.className='item'+(entregaAtiva===e?' active':'');

    d.innerHTML = `
      ${i+1}. ${e.nome}
      <button style="float:right"
        onclick="removerEntrega(${i});event.stopPropagation()">ğŸ—‘</button>
    `;

    d.onclick=()=>selecionarEntrega(i);
    l.appendChild(d);
  });
}


// ================= MARCADOR =================
function criarMarker(ent){
  const m = L.marker(ent.latlng,{draggable:true}).addTo(map);
  m.on('dragend',e=>{
    ent.latlng = e.target.getLatLng();
    salvar();
    atualizarRota();
  });
  markers.push(m);
}

// ================= ENTREGA =================
function novaEntrega(){
  alert('Clique no mapa');
  map.once('click',e=>{
    const nome = prompt('DescriÃ§Ã£o da entrega');
    if(!nome) return;
    const ent = {nome, latlng:e.latlng};
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
    falar('Entrega criada');
  });
}

function selecionarEntrega(i){
  entregaAtiva = entregas[i];
  avisos = {};
  map.setView(entregaAtiva.latlng,16);
  atualizarLista();
  atualizarRota();
  falar('Entrega selecionada');
}

// ================= ROTA =================
function atualizarRota(){
  if(!gpsLatLng || !entregaAtiva) return;

  if(rotaLinha) map.removeLayer(rotaLinha);

  rotaLinha = L.polyline(
    [gpsLatLng, entregaAtiva.latlng],
    {color:'#2196f3',weight:5}
  ).addTo(map);

  const d = map.distance(gpsLatLng, entregaAtiva.latlng);

  if(d<200 && !avisos['200']){
    falar('Faltam duzentos metros');
    vibrar(200); avisos['200']=true;
  }
  if(d<100 && !avisos['100']){
    falar('Faltam cem metros');
    vibrar([100,50,100]); avisos['100']=true;
  }
  if(d<30 && !avisos['fim']){
    falar('VocÃª chegou ao destino');
    vibrar([300,100,300]); avisos['fim']=true;
  }
}

// ================= Limpar Somente Rota =================
function limparRota(){
  if(rotaLinha){
    map.removeLayer(rotaLinha);
    rotaLinha = null;
  }
  entregaAtiva = null;
  avisos = {};
  falar('Rota limpa');
}


// ================= GPS =================
function ativarGPS(){
  if(!navigator.geolocation) return alert('GPS nÃ£o suportado');

  navigator.geolocation.watchPosition(pos=>{
    gpsLatLng = [pos.coords.latitude,pos.coords.longitude];

    if(!gpsMarker){
      gpsMarker = L.circleMarker(gpsLatLng,{
        radius:8,color:'#000',fillColor:'#2196f3',fillOpacity:1
      }).addTo(map);
      map.setView(gpsLatLng,16);
      falar('GPS ativado');
    }else{
      gpsMarker.setLatLng(gpsLatLng);
      map.setView(gpsLatLng,map.getZoom(),{animate:true});
    }

    atualizarRota();
  },
  ()=>alert('Erro no GPS'),
  {enableHighAccuracy:true});
}

// ================= CEP =================
async function buscarCEP(){
  let cep = prompt('Digite o CEP');
  if(!cep) return;
  cep = cep.replace(/\D/g,'');
  if(cep.length!==8) return alert('CEP invÃ¡lido');

  const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
  const d = await r.json();
  if(d.erro) return alert('CEP nÃ£o encontrado');

  const endereco = `${d.logradouro}, ${d.localidade} - ${d.uf}`;
  const g = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`
  );
  const geo = await g.json();
  if(!geo.length) return alert('Local nÃ£o encontrado');

  const latlng = [parseFloat(geo[0].lat),parseFloat(geo[0].lon)];
  map.setView(latlng,16);

  if(confirm('Salvar entrega?')){
    const ent={nome:endereco,latlng};
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
    falar('Entrega adicionada. Ajuste o ponto se necessÃ¡rio');
  }
}

// ================= LIMPAR =================
function limparTudo(){
  if(!confirm('Apagar tudo?')) return;
  markers.forEach(m=>map.removeLayer(m));
  if(rotaLinha) map.removeLayer(rotaLinha);
  entregas=[]; entregaAtiva=null;
  markers=[]; rotaLinha=null;
  salvar(); atualizarLista();
  falar('Tudo apagado');
}

// ================= Remover Entrega =================
function removerEntrega(i){
  if(!confirm('Remover esta entrega?')) return;

  const removida = entregas[i];

  map.removeLayer(markers[i]);
  markers.splice(i,1);
  entregas.splice(i,1);

  if(entregaAtiva === removida){
    entregaAtiva = null;
    if(rotaLinha){
      map.removeLayer(rotaLinha);
      rotaLinha = null;
    }
  }

  salvar();
  atualizarLista();
  falar('Entrega removida');
}

// ================= INIT =================
entregas.forEach(criarMarker);
atualizarLista();
</script>

</body>
</html>
